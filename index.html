<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://unpkg.com;">
    <title>TebuRun予約アプリモック</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="app-container">
        <!-- G1: ホーム & 駅選択 -->
        <main id="screen-g1" class="screen">
            <header class="app-header">
                <h1>TebuRun</h1>
            </header>
            <div class="content" id="g1-content">
                <div class="catch-copy">
                    <p>手ぶらで、走る。</p>
                    <p>新しい朝を、ここから。</p>
                </div>

                <div class="station-selector">
                    <div class="input-group">
                        <label for="origin-station">出発駅</label>
                        <div class="input-with-icon">
                            <i data-lucide="train"></i>
                            <input type="text" id="origin-station" placeholder="下のリストから選択" readonly>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="destination-station">到着駅</label>
                        <div class="input-with-icon">
                            <i data-lucide="running"></i>
                            <input type="text" id="destination-station" placeholder="下のリストから選択" readonly>
                        </div>
                    </div>
                </div>

                <div class="station-list-container">
                    <p class="list-header" id="station-selection-guide">出発駅を選択してください</p>
                    <div class="station-cards">
                        <div class="station-card" data-station-name="東京駅" data-locker-status="available" data-shower-status="available">
                            <div class="station-card-main">
                                <p class="card-title">東京駅</p>
                                <div class="facility-icons">
                                    <i data-lucide="locker"></i>
                                    <i data-lucide="shower"></i>
                                </div>
                            </div>
                        </div>
                        <div class="station-card" data-station-name="新宿駅" data-locker-status="available" data-shower-status="partial">
                            <div class="station-card-main">
                                <p class="card-title">新宿駅</p>
                                <div class="facility-icons">
                                    <i data-lucide="locker"></i>
                                    <i data-lucide="shower"></i>
                                </div>
                            </div>
                        </div>
                        <div class="station-card" data-station-name="品川駅" data-locker-status="unavailable" data-shower-status="unavailable">
                            <div class="station-card-main">
                                <p class="card-title">品川駅</p>
                                <div class="facility-icons">
                                    <i data-lucide="locker"></i>
                                    <i data-lucide="shower"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p class="error-message" id="selection-error-message"></p>
                <button class="btn-primary" id="to-schedule-btn" disabled>スケジュール選択へ</button>

            </div>
        </main>

        <!-- G2: スケジュール & 空き状況 (Initially Hidden) -->
        <section id="screen-g2" class="screen" style="display: none;">
            
            <header class="app-header">
                <h1>スケジュール</h1>
            </header>
            <div class="content">
                <div class="calendar-strip">
                    <div class="date-item"><p class="day-of-week">月</p><p class="day">28</p></div>
                    <div class="date-item"><p class="day-of-week">火</p><p class="day">29</p></div>
                    <div class="date-item active"><p class="day-of-week">水</p><p class="day">30</p></div>
                    <div class="date-item"><p class="day-of-week">木</p><p class="day">31</p></div>
                    <div class="date-item"><p class="day-of-week">金</p><p class="day">1</p></div>
                </div>

                <div class="time-slots-container">
                    <div class="time-slots-grid">
                        <button class="time-slot" data-time="07:00" data-status="available">07:00</button>
                        <button class="time-slot" data-time="07:30" data-status="partial">
                            07:30
                            <div class="availability-dots">
                                <span class="dot available" title="ロッカー"></span>
                                <span class="dot partial" title="シャワー"></span>
                            </div>
                        </button>
                        <button class="time-slot" data-time="08:00" data-status="available">08:00</button>
                        <button class="time-slot" data-time="08:30" data-status="available">08:30</button>
                        <button class="time-slot" data-time="09:00" data-status="unavailable">
                            09:00
                            <div class="availability-dots">
                                <span class="dot unavailable" title="ロッカー"></span>
                                <span class="dot unavailable" title="シャワー"></span>
                            </div>
                        </button>
                        <button class="time-slot" data-time="09:30" data-status="available">09:30</button>
                    </div>
                </div>

                <div class="price-card">
                    <div class="price-item">
                        <p class="price-label">料金</p>
                        <p class="price-value">¥1,200</p>
                    </div>
                    <div class="price-item">
                        <p class="price-label">予想所要時間</p>
                        <p class="price-value">約63分</p>
                    </div>
                </div>

                <button class="btn-primary">予約確認へ</button>
            </div>
            
        </section>

        <!-- G3: 予約確認モーダル (Initially Hidden) -->
        <div id="screen-g3" class="modal-overlay" style="display: none;">
            
            <div class="modal-content">
                <h2 class="modal-title">予約内容の確認</h2>
                <div class="reservation-details">
                    <div class="detail-item">
                        <span class="detail-label">日時</span>
                        <span class="detail-value" id="g3-datetime">2025年7月30日(水) 07:30</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">出発</span>
                        <span class="detail-value" id="g3-origin-station">東京駅</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">到着</span>
                        <span class="detail-value" id="g3-destination-station">新宿駅</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ロッカー</span>
                        <span class="detail-value" id="g3-locker-status">○</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">シャワー</span>
                        <span class="detail-value" id="g3-shower-status">△</span>
                    </div>
                </div>
                <div class="modal-price-summary">
                    <p class="total-label">お支払い金額</p>
                    <p class="total-value">¥1,200</p>
                </div>
                <button class="btn-primary">予約を確定する</button>
                <button class="btn-secondary">キャンセル</button>
            </div>
            
        </div>

        <!-- G4: My 予約（QR ロッカーキー） (Initially Hidden) -->
        <section id="screen-g4" class="screen" style="display: none;">
            
            <header class="app-header">
                <h1>My予約</h1>
            </header>
            <div class="content">
                <div class="qr-code-card">
                    <p class="qr-card-title">ロッカーキー</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=R1234567" alt="QR Code" class="qr-code-image">
                    <p class="reservation-id">ID: R1234567</p>
                </div>

                <div class="usage-details-card">
                    <div class="usage-detail-item">
                        <i data-lucide="calendar"></i>
                        <span>2025年7月30日(水) 07:30</span>
                    </div>
                    <div class="usage-detail-item">
                        <i data-lucide="train"></i>
                        <span>出発: 東京駅</span>
                    </div>
                    <div class="usage-detail-item">
                        <i data-lucide="running"></i>
                        <span>到着: 新宿駅</span>
                    </div>
                    <div class="usage-detail-item">
                        <i data-lucide="locker"></i>
                        <span>ロッカー: B-3</span>
                    </div>
                    <div class="usage-detail-item">
                        <i data-lucide="shower"></i>
                        <span>シャワー: No.5</span>
                    </div>
                </div>

                <button class="btn-danger">予約をキャンセル</button>
            </div>
            
        </section>
    </div>
    <script>
      let selectedOrigin = null;
      let selectedDestination = null;
      let selectedTimeSlot = null; // New variable for selected time slot

      const originInput = document.getElementById('origin-station');
      const destinationInput = document.getElementById('destination-station');
      const stationCards = document.querySelectorAll('.station-card');
      const toScheduleBtnG1 = document.getElementById('to-schedule-btn'); // Renamed for clarity
      const stationSelectionGuide = document.getElementById('station-selection-guide');
      const selectionErrorMessage = document.getElementById('selection-error-message');

      const screenG1 = document.getElementById('screen-g1');
      const screenG2 = document.getElementById('screen-g2');
      const timeSlotButtons = document.querySelectorAll('#screen-g2 .time-slot'); // New selector for time slots
      const toConfirmBtnG2 = document.querySelector('#screen-g2 .btn-primary'); // New selector for G2 button

      function updateG1UI() {
          console.log("--- updateG1UI called ---");
          console.log("selectedOrigin:", selectedOrigin ? selectedOrigin.dataset.stationName : "None");
          console.log("selectedDestination:", selectedDestination ? selectedDestination.dataset.stationName : "None");
          console.log("originInput.value:", originInput.value);
          console.log("destinationInput.value:", destinationInput.value);

          // Update selection guide
          if (!selectedOrigin) {
              stationSelectionGuide.textContent = '出発駅を選択してください';
          } else if (!selectedDestination) {
              stationSelectionGuide.textContent = '到着駅を選択してください';
          } else {
              stationSelectionGuide.textContent = '選択完了';
          }
          console.log("stationSelectionGuide:", stationSelectionGuide.textContent);

          // Update button state and error message
          if (selectedOrigin && selectedDestination) {
              const originLocker = selectedOrigin.dataset.lockerStatus;
              const originShower = selectedOrigin.dataset.showerStatus;
              const destLocker = selectedDestination.dataset.lockerStatus;
              const destShower = selectedDestination.dataset.showerStatus;

              const isOriginOk = originLocker !== 'unavailable' && originShower !== 'unavailable';
              const isDestOk = destLocker !== 'unavailable' && destShower !== 'unavailable';

              if (isOriginOk && isDestOk) {
                  toScheduleBtnG1.disabled = false;
                  selectionErrorMessage.textContent = '';
              } else {
                  toScheduleBtnG1.disabled = true;
                  let errorMessage = '選択した駅の施設に空きがないため、進めません。';
                  if (!isOriginOk && !isDestOk) {
                      errorMessage = `出発駅(${selectedOrigin.dataset.stationName})と到着駅(${selectedDestination.dataset.stationName})の施設に空きがありません。`;
                  } else if (!isOriginOk) {
                      errorMessage = `出発駅(${selectedOrigin.dataset.stationName})の施設に空きがありません。`;
                  } else if (!isDestOk) {
                      errorMessage = `到着駅(${selectedDestination.dataset.stationName})の施設に空きがありません。`;
                  }
                  selectionErrorMessage.textContent = errorMessage;
              }
          } else {
              toScheduleBtnG1.disabled = true;
              selectionErrorMessage.textContent = '出発駅と到着駅を選択してください。';
          }
          console.log("toScheduleBtnG1.disabled:", toScheduleBtnG1.disabled);
          console.log("selectionErrorMessage:", selectionErrorMessage.textContent);

          // Update card selection visual
          stationCards.forEach(card => {
              card.classList.remove('selected-origin', 'selected-destination');
              if (card === selectedOrigin) {
                  card.classList.add('selected-origin');
              } else if (card === selectedDestination) {
                  card.classList.add('selected-destination');
              }
          });
          console.log("--- End updateG1UI ---");
      }

      function updateIconColors() {
          stationCards.forEach(card => {
              const lockerIcon = card.querySelector('.facility-icons i[data-lucide="locker"]');
              const showerIcon = card.querySelector('.facility-icons i[data-lucide="shower"]');
              
              lockerIcon.classList.add(card.dataset.lockerStatus);
              showerIcon.classList.add(card.dataset.showerStatus);
          });
          lucide.createIcons(); // Re-render icons with new colors
      }

      function handleStationCardClick(card) {
          console.log("--- handleStationCardClick called ---");
          console.log("Clicked card:", card.dataset.stationName);
          console.log("Before click - selectedOrigin:", selectedOrigin ? selectedOrigin.dataset.stationName : "None");
          console.log("Before click - selectedDestination:", selectedDestination ? selectedDestination.dataset.stationName : "None");

          const stationName = card.dataset.stationName;

          if (!selectedOrigin) {
              // 1. Select Origin
              selectedOrigin = card;
              originInput.value = stationName;
          } else if (!selectedDestination && card !== selectedOrigin) {
              // 2. Select Destination
              selectedDestination = card;
              destinationInput.value = stationName;
          } else {
              // 3. Reset and select new origin
              selectedOrigin = card;
              selectedDestination = null;
              originInput.value = stationName;
              destinationInput.value = '';
          }
          console.log("After click - selectedOrigin:", selectedOrigin ? selectedOrigin.dataset.stationName : "None");
          console.log("After click - selectedDestination:", selectedDestination ? selectedDestination.dataset.stationName : "None");
          updateG1UI();
          console.log("--- End handleStationCardClick ---");
      }

      function handleToScheduleButtonG1Click() {
          if (!toScheduleBtnG1.disabled) {
              screenG1.style.display = 'none';
              screenG2.style.display = 'block';
              // Reset G2 state when navigating to it
              selectedTimeSlot = null;
              updateG2UI();
          }
      }

      function updateG2UI() {
          // Enable/disable G2 button based on time slot selection
          if (selectedTimeSlot) {
              toConfirmBtnG2.disabled = false;
          } else {
              toConfirmBtnG2.disabled = true;
          }

          // Update time slot selection visual
          timeSlotButtons.forEach(button => {
              button.classList.remove('selected');
              if (button === selectedTimeSlot) {
                  button.classList.add('selected');
              }
          });
      }

      function handleTimeSlotClick(button) {
          if (button.dataset.status === 'unavailable') {
              return; // Do nothing if the slot is unavailable
          }
          selectedTimeSlot = button;
          updateG2UI();
      }

      function handleToConfirmButtonG2Click() {
          if (!toConfirmBtnG2.disabled) {
              // Update G3 modal content
              document.getElementById('g3-datetime').textContent = `2025年7月30日(水) ${selectedTimeSlot.dataset.time}`;
              document.getElementById('g3-origin-station').textContent = selectedOrigin.dataset.stationName;
              document.getElementById('g3-destination-station').textContent = selectedDestination.dataset.stationName;
              document.getElementById('g3-locker-status').textContent = selectedDestination.dataset.lockerStatus === 'available' ? '○' : (selectedDestination.dataset.lockerStatus === 'partial' ? '△' : '×');
              document.getElementById('g3-shower-status').textContent = selectedDestination.dataset.showerStatus === 'available' ? '○' : (selectedDestination.dataset.showerStatus === 'partial' ? '△' : '×');

              // Show the G3 modal
              document.getElementById('screen-g3').style.display = 'flex';
          }
      }

      // Function to handle G3 modal close (e.g., clicking outside or cancel button)
      function handleG3ModalClose() {
          document.getElementById('screen-g3').style.display = 'none';
      }

      // Function to handle G3 confirm button click
      function handleG3ConfirmClick() {
          alert('予約を確定しました！'); // Placeholder for actual reservation logic
          document.getElementById('screen-g3').style.display = 'none';
          // Optionally navigate to G4 or reset to G1
          screenG2.style.display = 'none';
          screenG1.style.display = 'block';
          selectedOrigin = null;
          selectedDestination = null;
          selectedTimeSlot = null;
          originInput.value = '';
          destinationInput.value = '';
          updateG1UI();
      }

      function initializeUI() {
          lucide.createIcons();
          updateIconColors();
          updateG1UI(); // Initial UI update for G1
          updateG2UI(); // Initial UI update for G2

          stationCards.forEach(card => {
              card.addEventListener('click', () => handleStationCardClick(card));
          });

          toScheduleBtnG1.addEventListener('click', handleToScheduleButtonG1Click);

          timeSlotButtons.forEach(button => {
              button.addEventListener('click', () => handleTimeSlotClick(button));
          });

          toConfirmBtnG2.addEventListener('click', handleToConfirmButtonG2Click);

          // Add event listener for G3 modal close (e.g., clicking outside)
          document.getElementById('screen-g3').addEventListener('click', (event) => {
              if (event.target.id === 'screen-g3') { // Only close if clicking the overlay itself
                  handleG3ModalClose();
              }
          });
          // Add event listener for G3 cancel button
          document.querySelector('#screen-g3 .btn-secondary').addEventListener('click', handleG3ModalClose);
          // Add event listener for G3 confirm button
          document.querySelector('#screen-g3 .btn-primary').addEventListener('click', handleG3ConfirmClick);

      document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>